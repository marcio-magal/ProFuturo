{% extends 'base.html' %}

{% block main %}
    
    <h1>Página da PlayList: {{ playlist.name }}</h1>
    
    <iframe id="video-player"
            width="560"
            height="315"
            src="https://www.youtube.com/embed/{{ videos.0.youtube_id }}"
            title="YouTube video player"
            frameborder="0"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
            referrerpolicy="strict-origin-when-cross-origin"
            allowfullscreen>
    </iframe>

    <div>
        <button id="like-button" data-video-id="{{ videos.0.id }}">Curtir</button>
        <span id="like-count">{{ videos.0.likes }}</span> Curtidas
    </div>

    <div>
        <h3>Comentários</h3>
        <ul id="comment-list">
            {% for comment in videos.0.comments.all %}
                <li data-comment-id="{{ comment.id }}">
                    <strong>{{ comment.user.username }}</strong>: <span class="comment-text">{{ comment.text }}</span>
                    {% if comment.user == request.user %}
                        <button class="edit-comment">Editar</button>
                        <button class="delete-comment">Excluir</button>
                    {% endif %}
                </li>
            {% empty %}
                <p>Não há comentários ainda.</p>
            {% endfor %}
        </ul>
        <textarea id="new-comment-text" placeholder="Adicionar um comentário..."></textarea>
        <button id="add-comment-button">Comentar</button>
    </div>

    <h3>Vídeos da Playlist</h3>
    <ul id="video-list">
        {% for video in videos %}
            <li>
                <a href="#" class="video-link" data-video-id="{{ video.youtube_id }}" data-video-db-id="{{ video.id }}">
                    {{ video.title }}
                </a>
            </li>
        {% empty %}
            <p>Não há vídeos nesta playlist.</p>
        {% endfor %}
    </ul>

    <script>
        // Função para atualizar o botão de curtir e o contador de curtidas
        function updateLikeButton(videoDbId) {
            fetch(`/playlist/like/${videoDbId}/status/`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                }
            })
            .then(response => response.json())
            .then(data => {
                const likeButton = document.getElementById('like-button');
                const likeCount = document.getElementById('like-count');
                
                likeCount.textContent = data.likes;
                likeButton.setAttribute('data-video-id', videoDbId);

                if (data.liked) {
                    likeButton.textContent = 'Descurtir';
                } else {
                    likeButton.textContent = 'Curtir';
                }
            });
        }

        // Script para trocar o vídeo do iframe
        document.querySelectorAll('.video-link').forEach(link => {
            link.addEventListener('click', function(event) {
                event.preventDefault();
                const videoId = this.getAttribute('data-video-id');
                const dbVideoId = this.getAttribute('data-video-db-id');
                const iframe = document.getElementById('video-player');
                
                // Troca o vídeo no iframe
                iframe.src = `https://www.youtube.com/embed/${videoId}`;
                
                // Atualiza o botão de curtir para o novo vídeo
                updateLikeButton(dbVideoId);
            });
        });

        // Script para curtir ou descurtir o vídeo
        document.getElementById('like-button').addEventListener('click', function() {
            const videoId = this.getAttribute('data-video-id');

            fetch(`/playlist/like/${videoId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                const likeButton = document.getElementById('like-button');
                const likeCount = document.getElementById('like-count');
                
                likeCount.textContent = data.likes;

                if (data.liked) {
                    likeButton.textContent = 'Descurtir';
                } else {
                    likeButton.textContent = 'Curtir';
                }
            });
        });

        // Atualiza o botão de curtir para o vídeo que é carregado inicialmente
        document.addEventListener("DOMContentLoaded", function() {
            updateLikeButton("{{ videos.0.id }}");
        });
        
        
        // Função para adicionar um novo comentário
        document.getElementById('add-comment-button').addEventListener('click', function() {
            const videoId = document.getElementById('like-button').getAttribute('data-video-id');
            const text = document.getElementById('new-comment-text').value;

            fetch(`/playlist/comment/add/${videoId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `text=${encodeURIComponent(text)}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                } else {
                    const commentList = document.getElementById('comment-list');
                    const newComment = document.createElement('li');
                    newComment.setAttribute('data-comment-id', data.id);
                    newComment.innerHTML = `<strong>${data.user}</strong>: <span class="comment-text">${data.text}</span>`;
                    if (data.user === "{{ request.user.username }}") {
                        newComment.innerHTML += `
                            <button class="edit-comment">Editar</button>
                            <button class="delete-comment">Excluir</button>`;
                    }
                    commentList.appendChild(newComment);
                    document.getElementById('new-comment-text').value = '';
                }
            });
        });

        // Função para editar um comentário
        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('edit-comment')) {
                const commentElement = event.target.closest('li');
                const commentId = commentElement.getAttribute('data-comment-id');
                const newText = prompt('Edite seu comentário:', commentElement.querySelector('.comment-text').textContent);

                if (newText) {
                    fetch(`/playlist/comment/edit/${commentId}/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}',
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: `text=${encodeURIComponent(newText)}`
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            alert(data.error);
                        } else {
                            commentElement.querySelector('.comment-text').textContent = data.text;
                        }
                    });
                }
            }
        });

        // Função para excluir um comentário
        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('delete-comment')) {
                const commentElement = event.target.closest('li');
                const commentId = commentElement.getAttribute('data-comment-id');

                fetch(`/playlist/comment/delete/${commentId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        commentElement.remove();
                    } else {
                        alert('Erro ao excluir o comentário.');
                    }
                });
            }
        });
    </script>    
{% endblock %}
